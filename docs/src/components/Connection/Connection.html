<!DOCTYPE html>

<html>
<head>
  <title>Connection.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="../../../docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="../App/App.html">
                  src/components/App/App.js
                </a>
              
                
                <a class="source" href="../App/ErrorBoundary.html">
                  src/components/App/ErrorBoundary.js
                </a>
              
                
                <a class="source" href="../App/i18n.html">
                  src/components/App/i18n.js
                </a>
              
                
                <a class="source" href="../Auth/Auth.html">
                  src/components/Auth/Auth.js
                </a>
              
                
                <a class="source" href="../Auth/AuthActions.html">
                  src/components/Auth/AuthActions.js
                </a>
              
                
                <a class="source" href="../Auth/AuthReducer.html">
                  src/components/Auth/AuthReducer.js
                </a>
              
                
                <a class="source" href="../Button/Button.html">
                  src/components/Button/Button.js
                </a>
              
                
                <a class="source" href="../Cat/Cat.html">
                  src/components/Cat/Cat.js
                </a>
              
                
                <a class="source" href="../Cat/CatActions.html">
                  src/components/Cat/CatActions.js
                </a>
              
                
                <a class="source" href="../Cat/CatReducer.html">
                  src/components/Cat/CatReducer.js
                </a>
              
                
                <a class="source" href="../Cat/fulltilt.html">
                  src/components/Cat/fulltilt.js
                </a>
              
                
                <a class="source" href="Connection.html">
                  src/components/Connection/Connection.js
                </a>
              
                
                <a class="source" href="ConnectionActions.html">
                  src/components/Connection/ConnectionActions.js
                </a>
              
                
                <a class="source" href="ConnectionReducer.html">
                  src/components/Connection/ConnectionReducer.js
                </a>
              
                
                <a class="source" href="messages.html">
                  src/components/Connection/messages.js
                </a>
              
                
                <a class="source" href="../Intro/Intro.html">
                  src/components/Intro/Intro.js
                </a>
              
                
                <a class="source" href="../Intro/IntroActions.html">
                  src/components/Intro/IntroActions.js
                </a>
              
                
                <a class="source" href="../Particles/Particles.html">
                  src/components/Particles/Particles.js
                </a>
              
                
                <a class="source" href="../Pulse/Pulse.html">
                  src/components/Pulse/Pulse.js
                </a>
              
                
                <a class="source" href="../Router/Router.html">
                  src/components/Router/Router.js
                </a>
              
                
                <a class="source" href="../Sound/CatSound.html">
                  src/components/Sound/CatSound.js
                </a>
              
                
                <a class="source" href="../Sound/Mute.html">
                  src/components/Sound/Mute.js
                </a>
              
                
                <a class="source" href="../Sound/Sound.html">
                  src/components/Sound/Sound.js
                </a>
              
                
                <a class="source" href="../Sound/TurningSound.html">
                  src/components/Sound/TurningSound.js
                </a>
              
                
                <a class="source" href="../Spinner/Spinner.html">
                  src/components/Spinner/Spinner.js
                </a>
              
                
                <a class="source" href="../Typing/Typing.html">
                  src/components/Typing/Typing.js
                </a>
              
                
                <a class="source" href="../../configureStore.html">
                  src/configureStore.js
                </a>
              
                
                <a class="source" href="../../index.html">
                  src/index.js
                </a>
              
                
                <a class="source" href="../../serviceWorker.html">
                  src/serviceWorker.js
                </a>
              
                
                <a class="source" href="../../setupTests.html">
                  src/setupTests.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>Connection.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>Connection
Manages connection with robot, subscribes to robot events</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">import</span> React, { memo, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>; <span class="hljs-comment">// eslint-disable-line no-unused-vars</span>
<span class="hljs-keyword">import</span> PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>;
<span class="hljs-keyword">import</span> { connect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-redux'</span>;

<span class="hljs-keyword">import</span> PubNub <span class="hljs-keyword">from</span> <span class="hljs-string">'pubnub'</span>;
<span class="hljs-keyword">import</span> uuidv4 <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid/v4'</span>;
<span class="hljs-keyword">import</span> log <span class="hljs-keyword">from</span> <span class="hljs-string">'loglevel'</span>;

<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> actions <span class="hljs-keyword">from</span> <span class="hljs-string">'./ConnectionActions.js'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> messages <span class="hljs-keyword">from</span> <span class="hljs-string">'./messages.js'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> MESSAGE_CHANNEL = <span class="hljs-string">'MESSAGE'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> CONNECTION_TOKEN = <span class="hljs-string">'connectionToken'</span>;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> CONNECTION_ID = <span class="hljs-string">'connectionId'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> CONNECTION_TIMEOUT_DELAY = <span class="hljs-number">15000</span>; <span class="hljs-comment">//10000;</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> HEARTBEAT_TIMEOUT_DELAY = <span class="hljs-number">15000</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> HEARTBEAT_INTERVAL = <span class="hljs-number">3000</span>;
<span class="hljs-keyword">const</span> FORBIDDEN = <span class="hljs-number">403</span>;

<span class="hljs-keyword">let</span> pubnub;
<span class="hljs-keyword">let</span> connectionTimeout;
<span class="hljs-keyword">let</span> heartbeatTimeout;

<span class="hljs-keyword">export</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Connection</span>(<span class="hljs-params">{
  authSuccessful,
  authForbidden,
  authFailed,
  connectionTimedOut,
  turnLeft,
  turnRight,
  updateTurn,
  cat,
  catKey = null,
  ...messages
}</span>) </span>{
  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (catKey) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>setup connection timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      connectionTimeout = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>if timed out, unsubscribe from messages and notify app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        clearConnection();
        connectionTimedOut();
      }, CONNECTION_TIMEOUT_DELAY);</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>authenticate with robot</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      initPubnub(catKey)</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>check if authenticated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> checkAuth(authSuccessful, authForbidden, authFailed);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>subscribe to messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> subscribe(messages);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>send connection request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> connectToRobot();
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>eslint-disable-next-line no-unused-vars</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
          log.info(<span class="hljs-string">'could not connect to cat robot'</span>);
        });
    }

    <span class="hljs-keyword">return</span> unsubscribe;
  }, [catKey]);

  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (turnLeft) {
      requestLeftTurn();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (turnRight) {
      requestRightTurn();
    }
  }, [turnLeft, turnRight, updateTurn]);

  useEffect(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (cat &amp;&amp; !catKey) {
      <span class="hljs-keyword">const</span> connectionToken = getConnectionToken();
      <span class="hljs-keyword">if</span> (!connectionToken) {
        clearConnection();
        messages.disconnected();
        <span class="hljs-keyword">return</span>;
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>try to reconnect with connection token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      initPubnub(connectionToken)</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>check if authenticated</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> checkAuth(authSuccessful, authForbidden, authFailed, <span class="hljs-literal">true</span>);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>subscribe to messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          <span class="hljs-keyword">return</span> subscribe(messages);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>start heartbeat</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .then(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
          sendHeartbeat(messages.disconnected);
        })</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>eslint-disable-next-line no-unused-vars</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        .catch(<span class="hljs-function"><span class="hljs-params">e</span> =&gt;</span> {
          log.info(<span class="hljs-string">'could not reconnect'</span>);
        });
    }
  }, [catKey]);

  <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>initialize pubnub</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initPubnub</span>(<span class="hljs-params">catKey</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    pubnub = <span class="hljs-keyword">new</span> PubNub({
      <span class="hljs-attr">publishKey</span>: process.env.REACT_APP_PUBLISH_KEY,
      <span class="hljs-attr">subscribeKey</span>: process.env.REACT_APP_SUBSCRIBE_KEY,
      <span class="hljs-attr">authKey</span>: catKey,
      <span class="hljs-attr">ssl</span>: <span class="hljs-literal">true</span>
    });

    resolve();
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>send test message to check auth</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkAuth</span>(<span class="hljs-params">authSuccessful, authForbidden, authFailed, isReconnect</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    pubnub.publish(
      {
        <span class="hljs-attr">channel</span>: MESSAGE_CHANNEL,
        <span class="hljs-attr">message</span>: messages.AUTH
      },
      ({ error, statusCode }) =&gt; {
        <span class="hljs-keyword">if</span> (statusCode === FORBIDDEN) {
          log.info(<span class="hljs-string">'authentication failed, invalid key'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>clear connection timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          clearTimeout(connectionTimeout);

          authForbidden(isReconnect);
          reject();
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (error) {
          log.info(<span class="hljs-string">'authentication failed'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>clear connection timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>          clearTimeout(connectionTimeout);

          authFailed(isReconnect);
          reject();
          <span class="hljs-keyword">return</span>;
        }

        log.info(<span class="hljs-string">'authenticated'</span>);
        authSuccessful();
        resolve();
      }
    );
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>subscribe to pubnub messages channel, handle incoming messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subscribe</span>(<span class="hljs-params">{
  connectionSuccessful,
  connectionConflict,
  robotCurrentlyTurning,
  robotTurningLeft,
  robotTurningRight,
  robotCompletedTurn,
  catDetected,
  disconnected
}</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    pubnub.addListener({
      <span class="hljs-attr">message</span>: <span class="hljs-function">(<span class="hljs-params">{ message }</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (message[messages.CONNECTED]) {
          <span class="hljs-keyword">if</span> (message[messages.CONNECTED] !== getConnectionId()) {
            <span class="hljs-keyword">return</span>;
          }
          handleConnectedMessage(message.token, connectionSuccessful, disconnected);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message[messages.CONFLICT]) {
          <span class="hljs-keyword">if</span> (message[messages.CONFLICT] !== getConnectionId()) {
            <span class="hljs-keyword">return</span>;
          }
          handleConnectionConflictMessage(connectionConflict);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message[messages.CONNECTION_OK]) {
          <span class="hljs-keyword">if</span> (message[messages.CONNECTION_OK] !== getConnectionId()) {
            <span class="hljs-keyword">return</span>;
          }
          handleHeartbeatResponseMessage(disconnected);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message === messages.TURN_IN_PROGRESS) {
          handleTurnInProgressMessage(robotCurrentlyTurning);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message === messages.TURNING_LEFT) {
          handleLeftTurnAcceptedMessage(robotTurningLeft);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message === messages.TURNING_RIGHT) {
          handleRightTurnAcceptedMessage(robotTurningRight);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message === messages.TURN_COMPLETED) {
          handleTurnCompletedMessage(robotCompletedTurn);
          <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">if</span> (message === messages.CAT_DETECTED) {
          handleCatDetectedMessage(catDetected);
        }
      }
    });

    pubnub.subscribe({
      <span class="hljs-attr">channels</span>: [MESSAGE_CHANNEL]
    });

    resolve();
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>send connection request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">connectToRobot</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">const</span> connectionId = uuidv4();
  setConnectionId(connectionId);

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    pubnub.publish(
      {
        <span class="hljs-attr">channel</span>: MESSAGE_CHANNEL,
        <span class="hljs-attr">message</span>: {
          [messages.CONNECTION_REQUEST]: getConnectionId()
        }
      },
      ({ error }) =&gt; {
        <span class="hljs-keyword">if</span> (error) {
          log.error(<span class="hljs-string">'error occurred sending connection message'</span>);
          reject();
          <span class="hljs-keyword">return</span>;
        }

        log.info(<span class="hljs-string">'sent connection message'</span>);
        resolve();
      }
    );
  });
}</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>send heartbeat</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sendHeartbeat</span>(<span class="hljs-params">disconnected</span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>setup heartbeat timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  heartbeatTimeout = setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>if timed out, unsubscribe from messages and notify app of disconnection</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    log.info(<span class="hljs-string">'heartbeat timed out!'</span>);

    clearConnection();
    disconnected();
  }, HEARTBEAT_TIMEOUT_DELAY);</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>send heartbeat message with connection id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pubnub.publish(
    {
      <span class="hljs-attr">channel</span>: MESSAGE_CHANNEL,
      <span class="hljs-attr">message</span>: {
        [messages.CONNECTION_TEST]: getConnectionId()
      }
    },
    ({ error }) =&gt; {
      <span class="hljs-keyword">if</span> (error) {
        log.error(<span class="hljs-string">'error occured sending heartbeat'</span>);
        <span class="hljs-keyword">return</span>;
      }

      log.trace(<span class="hljs-string">'sent heartbeat'</span>);
    }
  );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>send right turn request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestRightTurn</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>send turn request with connection id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pubnub.publish(
    {
      <span class="hljs-attr">channel</span>: MESSAGE_CHANNEL,
      <span class="hljs-attr">message</span>: {
        [messages.RIGHT_TURN_REQUEST]: getConnectionId()
      }
    },
    ({ error }) =&gt; {
      <span class="hljs-keyword">if</span> (error) {
        log.error(<span class="hljs-string">'error occurred sending turn right request'</span>);
        <span class="hljs-keyword">return</span>;
      }

      log.info(<span class="hljs-string">'sent turn right request'</span>);
    }
  );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>send left turn request</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">requestLeftTurn</span>(<span class="hljs-params"></span>) </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>send turn request with connection id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  pubnub.publish(
    {
      <span class="hljs-attr">channel</span>: MESSAGE_CHANNEL,
      <span class="hljs-attr">message</span>: {
        [messages.LEFT_TURN_REQUEST]: getConnectionId()
      }
    },
    ({ error }) =&gt; {
      <span class="hljs-keyword">if</span> (error) {
        log.error(<span class="hljs-string">'error occurred sending turn left request'</span>);
        <span class="hljs-keyword">return</span>;
      }

      log.info(<span class="hljs-string">'sent turn left request'</span>);
    }
  );
}</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>handle connected message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleConnectedMessage</span>(<span class="hljs-params">connectionToken, connectionSuccessful, disconnected</span>) </span>{
  log.info(<span class="hljs-string">'connected to robot'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>clear connection timeout</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clearTimeout(connectionTimeout);</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>store connection token in session storage</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  setConnectionToken(connectionToken);

  connectionSuccessful();</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>send heartbeat</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  sendHeartbeat(disconnected);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>handle connection conflict message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleConnectionConflictMessage</span>(<span class="hljs-params">connectionConflict</span>) </span>{
  log.info(<span class="hljs-string">'robot already has another connection'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>clear connection timeout and unsubscribe</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clearTimeout(connectionTimeout);
  clearConnection();

  connectionConflict();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>handle heartbeat response</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleHeartbeatResponseMessage</span>(<span class="hljs-params">disconnected</span>) </span>{
  log.trace(<span class="hljs-string">'connection ok'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>queue up next heartbeat</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  clearTimeout(heartbeatTimeout);
  setTimeout(<span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
    sendHeartbeat(disconnected);
  }, HEARTBEAT_INTERVAL);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>handle turn on progress message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleTurnInProgressMessage</span>(<span class="hljs-params">robotCurrentlyTurning</span>) </span>{
  log.info(<span class="hljs-string">'turn request rejected, turn in progress'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>notify app</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  robotCurrentlyTurning();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>handle left turn accepted message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleLeftTurnAcceptedMessage</span>(<span class="hljs-params">robotTurningLeft</span>) </span>{
  log.info(<span class="hljs-string">'left turn request accepted'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>notify app that robot is turning left</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  robotTurningLeft();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>handle right turn accepted message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleRightTurnAcceptedMessage</span>(<span class="hljs-params">robotTurningRight</span>) </span>{
  log.info(<span class="hljs-string">'right turn request accepted'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>notify app that robot is turning right</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  robotTurningRight();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>handle turn completed message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleTurnCompletedMessage</span>(<span class="hljs-params">robotCompletedTurn</span>) </span>{
  log.info(<span class="hljs-string">'turn completed'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>notify app that robot is done turning</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  robotCompletedTurn();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>handle cat detected message</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleCatDetectedMessage</span>(<span class="hljs-params">catDetected</span>) </span>{
  log.info(<span class="hljs-string">'cat detected'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>notify app that cat detected</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  catDetected();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>get stored connection token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConnectionToken</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> sessionStorage.getItem(CONNECTION_TOKEN);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>get stored connectionId</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getConnectionId</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> sessionStorage.getItem(CONNECTION_ID);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>store connection token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setConnectionToken</span>(<span class="hljs-params">connectionToken</span>) </span>{
  sessionStorage.setItem(CONNECTION_TOKEN, connectionToken);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>store connection id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">setConnectionId</span>(<span class="hljs-params">connectionId</span>) </span>{
  sessionStorage.setItem(CONNECTION_ID, connectionId);
}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>clear stored connection id and token and unsubscribe from messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clearConnection</span>(<span class="hljs-params"></span>) </span>{
  sessionStorage.clear();
  unsubscribe();
}</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>unsubscribe from pubnub messages</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">unsubscribe</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">if</span> (pubnub) {
    pubnub.unsubscribeAll();
  }
}

Connection.propTypes = {
  <span class="hljs-attr">cat</span>: PropTypes.bool,
  <span class="hljs-attr">catKey</span>: PropTypes.string,
  <span class="hljs-attr">turnLeft</span>: PropTypes.bool,
  <span class="hljs-attr">turnRight</span>: PropTypes.bool,
  <span class="hljs-attr">authSuccessful</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">authFailed</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">authForbidden</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">connectionSuccessful</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">connectionTimedOut</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">connectionConflict</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">robotTurningRight</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">robotTurningLeft</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">robotCompletedTurn</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">robotCurrentlyTurning</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">disconnected</span>: PropTypes.func.isRequired,
  <span class="hljs-attr">catDetected</span>: PropTypes.func.isRequired
};

<span class="hljs-keyword">const</span> mapStateToProps = <span class="hljs-function"><span class="hljs-params">state</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">catKey</span>: state.connection.catKey,
    <span class="hljs-attr">turnLeft</span>: state.connection.turnLeft,
    <span class="hljs-attr">turnRight</span>: state.connection.turnRight,
    <span class="hljs-attr">updateTurn</span>: state.connection.updateTurn
  };
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> connect(
  mapStateToProps,
  {
    <span class="hljs-attr">authSuccessful</span>: actions.authSuccessful,
    <span class="hljs-attr">authFailed</span>: actions.authFailedAsync,
    <span class="hljs-attr">authForbidden</span>: actions.authForbiddenAsync,
    <span class="hljs-attr">connectionSuccessful</span>: actions.connectionSuccessfulAsync,
    <span class="hljs-attr">connectionTimedOut</span>: actions.connectionTimedOut,
    <span class="hljs-attr">connectionConflict</span>: actions.connectionConflict,
    <span class="hljs-attr">robotTurningRight</span>: actions.robotTurningRight,
    <span class="hljs-attr">robotTurningLeft</span>: actions.robotTurningLeft,
    <span class="hljs-attr">robotCompletedTurn</span>: actions.robotCompletedTurn,
    <span class="hljs-attr">robotCurrentlyTurning</span>: actions.robotCurrentlyTurning,
    <span class="hljs-attr">disconnected</span>: actions.disconnectedAsync,
    <span class="hljs-attr">catDetected</span>: actions.catDetectedAsync
  }
)(memo(Connection));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
